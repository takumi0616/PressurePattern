# コマンド
```bash
nohup python main_v1.py > main_v1.txt 2>&1 &
```



# 研究概要


現在私は気圧配置分類の研究を行なっています
使用するデータは以下になります

---

データと前処理
• 物理量：海面更正気圧（SLP）
• 領域：日本周辺域（15–55°N, 115–155°E）格子点 161×161
• 期間：学習 1991–1997 年，検証 1998–2000 年（日次 09 Japan Standard Time; JST）
• ラベル：吉野[10] の「気圧配置ごよみ」準拠
• 前処理：Pa から hPa へ変換後，領域平均を引く．

本研究で用いるラベル体系は，吉野 [10] の付録 B「気圧配置ごよみ」に準拠する．基本型は以下の 6 分類（計 15 サブタイプ）で構成される：

1. 西高東低冬型 冬季に特徴的なシベリア高気圧とアリューシャン低気圧に起因する西高東低の場．
2. 気圧の谷型 低気圧あるいは気圧の谷の通過に対応する型．

- A. 低気圧が北海道またはサハリン付近を東に進む
- B. 低気圧が日本海から北東に進む
- C. 低気圧が台湾から日本の太平洋岸を東～東北東に進む
- D. 二つ玉低気圧，または日本海と太平洋に低圧部

3. 移動性高気圧型 移動性高気圧に覆われる型．

- A. 日本の北方または北部を東に進む
- B. 日本列島上（主として本州上）を東に進む
- C. 帯状高気圧
- D. 日本の太平洋岸または南方を東に進む

4. 前線型 停滞性の前線が卓越する型．

- A. 日本列島上をほぼ東西方向に走る主として停滞性の前線
- B. 太平洋岸または日本南方をほぼ東西方向に走る主として停滞性の前線

5. 南高北低夏型 原則として北太平洋高気圧が日本列島を支配する夏型．
6. 台風型 台風の位置に応じて次のサブタイプに区分する．

- A. 台風が南九州より南方の海上にある場合
- B. 台風が本州およびその接岸地帯にある場合
- C. 台風が北日本にある場合
  この他に，移行型（例：「3A - 2D」）と複合型（例：「2A+ 2C」）が定義されている
  複合型は基本的に若い番号が先に来ている 1 と 4A なら 1 が先に来て構成される（例：1+4A）
  移行型は順番に意味があり、1 つ目のラベルから 2 つ目のラベルに移行しているという状況を表している

具体的なラベルの状況

期間: 1991-01-01 〜 2000-12-31
対象データ数: 3653
 Label    Count    Percent

---

1      375     10.266
    2A       61      1.670
    2B       81      2.217
    2C       80      2.190
    2D      170      4.654
    3A       53      1.451
    3B      321      8.787
    3C      101      2.765
    3D       63      1.725
    4A      203      5.557
    4B      126      3.449
     5       69      1.889
    6A        7      0.192
    6B       15      0.411
    6C        2      0.055

---

TOTAL     1727     47.276
 OTHER     1926     52.724

【複合ラベル（Base±Base）統計】

- 出現総数: 1926 / 3653 (52.724%)
- 異なる複合ラベルの種類数: 161  (+ 種類: 109, - 種類: 52)
- 出現上位（最大 30 件）:
       3B+4B :    111 (3.039%)
       2A+4B :    111 (3.039%)
        4A+5 :    105 (2.874%)
       3A+4B :    101 (2.765%)
        1+4B :     83 (2.272%)
       2A+2C :     73 (1.998%)
        1+2A :     69 (1.889%)
       2A+4A :     54 (1.478%)
       3A+4A :     49 (1.341%)
       2A+3C :     49 (1.341%)
       4A+6A :     48 (1.314%)
       3C+4B :     46 (1.259%)
       2A+3D :     45 (1.232%)
        2A-1 :     43 (1.177%)
        5+6A :     35 (0.958%)
        1+2C :     34 (0.931%)
       2B+4B :     34 (0.931%)
       2A+3B :     33 (0.903%)
        2A+5 :     31 (0.849%)
       2A+2B :     29 (0.794%)
        1-3B :     28 (0.766%)
        1+2B :     27 (0.739%)
       2C+3A :     23 (0.630%)
       3A+6A :     22 (0.602%)
       2B+4A :     21 (0.575%)
       3B+4A :     20 (0.547%)
       3A+2C :     19 (0.520%)
        1+3C :     19 (0.520%)
       4A+6B :     19 (0.520%)
       3B+3D :     18 (0.493%)

---

現状は海面更生気圧だけですが、この変数も増やしたいと考えています（前線など、他の変数がなければ推測が難しいため）
era5 から取得可能な変数ならなんでも取れます（取得する際は格子点と範囲は統一します）

今回の研究で難しい点として、以下が考えられます

- ラベルが２つあるものがある
- 重要なラベルなのにデータ数がほぼないのもがあること（特に台風）、それらのラベルは移行型や複合型の方に多くあるため、そっちも使ってラベルを学習しないといけない

本研究を行うための手法（考えられるもの）や必要な気象変数（era5 から取得するべきもの）、プログラムの処理やアルゴリズムの方式など詳しく考察して日本語で解説してください

---

拝見しました。非常に興味深い研究テーマですね。気圧配置の客観的分類は、気象学において重要な課題です。ご提示のデータセットと課題、特に複合・移行ラベルの存在とデータ不均衡は、この研究を難しくもやりがいのあるものにしています。

以下に、ご研究を成功させるための手法、追加すべき気象変数、具体的なアルゴリズムについて、詳細な考察と提案を述べさせていただきます。

---

## 1. 研究手法の提案：深層学習（CNN）の活用

この研究の核心は、**2 次元の格子点データ（気圧配置図）からパターンを認識**することです。これは画像認識問題と非常によく似ており、現代の AI 技術、特に**畳み込みニューラルネットワーク（CNN）** が最も適した手法と考えられます。

### なぜ CNN が有効か？

- **空間的特徴の自動抽出**: CNN は、フィルター（カーネル）を用いて画像（この場合は気圧配置図）を走査し、高気圧の中心、気圧の谷、前線帯のような局所的・大局的な空間パターンを自動で学習する能力に長けています。人間が特徴量を設計する必要がありません。
- **表現学習**: 層を深くすることで、低気圧や高気圧といった単純な要素から、「西高東低」のようなより複雑で抽象的な気圧配置パターンまで、階層的に特徴を捉えることができます。

### モデルアーキテクチャの提案

- **基本構造**: `入力層` -> `畳み込み層 (Conv2D)` -> `活性化関数 (ReLU)` -> `プーリング層 (MaxPooling2D)` というブロックを数回繰り返し、最後に `全結合層 (Dense)` に繋いで出力を得る、という標準的な CNN アーキテクチャが基本となります。
- **応用アーキテクチャ**: より高い精度を目指す場合、**ResNet** や **Inception** のような、画像認識コンペティションで高い性能を実証済みの高名なアーキテクチャを参考にすると良いでしょう。これらは勾配消失問題を解決し、より深いネットワークの学習を可能にします。
- **出力層の設計（重要）**:
  - **問題設定**: このタスクは「15 種類の基本ラベルのうち、どれか 1 つに分類する」という単純な問題ではなく、「**15 種類の基本ラベルが、それぞれ存在するか否か（Yes/No）を判定する**」という **マルチラベル分類問題** として捉えるのが最適です。
  - **実装**:
    - 出力層のニューロン数: 基本ラベルの総数（15 個）にします。
    - 活性化関数: 各ラベルが独立して出現しうるため、`softmax` ではなく **`sigmoid`** を使用します。これにより、各出力ニューロンが「ラベル 1 が存在する確率」「ラベル 2A が存在する確率」…といった個別の確率（0〜1）を出力できます。
    - 損失関数: **`binary_crossentropy`** を使用します。

---

## 2. 追加すべき気象変数（ERA5 から取得）

海面更正気圧（SLP）は最も重要な変数ですが、それだけでは「前線型」や「台風型」の判別が困難なのはご指摘の通りです。気圧配置は 3 次元的な大気の構造の結果として現れるため、以下の変数を追加することで、モデルの性能が飛躍的に向上する可能性があります。

| 変数名（日本語）         | 変数名（ERA5）                             | 高度             | なぜ重要か？                                                                                                             |
| :----------------------- | :----------------------------------------- | :--------------- | :----------------------------------------------------------------------------------------------------------------------- |
| **ジオポテンシャル高度** | `Geopotential`                             | 500 hPa          | 上空の気圧の谷や尾根（偏西風の蛇行）を捉えるため。大気全体の流れを支配し、地上天気と密接に関連する最も重要な変数の一つ。 |
| **気温**                 | `Temperature`                              | 850 hPa          | 暖気と寒気の流入（温度移流）を捉えるため。前線の判別に不可欠。                                                           |
| **風の東西・南北成分**   | `U/V component of wind`                    | 850 hPa, 500 hPa | 低気圧性・高気圧性の循環や、台風に伴う強風域を直接的に学習させるため。                                                   |
| **相対湿度 or 比湿**     | `Relative humidity` or `Specific humidity` | 700 hPa, 850 hPa | 湿潤域（前線や台風に伴う雲域）を特定するため。「気圧の谷型」や「前線型」の判別に有効。                                   |
| **渦度（相対渦度）**     | `Vorticity (relative)`                     | 850 hPa          | 大気の回転を直接示す物理量。低気圧（正の渦度）や高気圧（負の渦度）の中心をより明確に特定できる。                         |

これらの変数を SLP と合わせて、**チャネル**として入力データに加えます。例えば、SLP、500hPa 高度、850hPa 気温の 3 変数を使う場合、入力データの次元は `(サンプル数, 161, 161, 3)` となります。これはカラー画像の RGB チャネルと同じ考え方です。

---

## 3. データ処理とアルゴリズムの詳細

課題である「複合・移行ラベル」と「データ不均衡」に対処するための具体的な処理方法を解説します。

### ステップ 1：ラベルのベクトル化（最重要）

まず、多様なラベル形式をモデルが学習できる統一された形式に変換する必要があります。前述のマルチラベル分類のアプローチに基づき、**マルチホットエンコーディング** を行います。

1.  **ユニークな基本ラベルのリストを作成**: `['1', '2A', '2B', ..., '6C']` という 15 種類のラベルリストを定義します。
2.  **15 次元のゼロベクトルを準備**: 各データに対して、`[0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0]` のようなベクトルを用意します。
3.  **ラベルをベクトルに変換**:
    - **基本ラベル** (例: `3B`): 対応するインデックスを `1` にします。→ `[0,0,0,0,0,0,1,0,0,...]`
    - **複合ラベル** (例: `3B+4B`): 対応する **両方** のインデックスを `1` にします。→ `[...,0,1(3B),0,0,1(4B),...]`
    - **移行ラベル** (例: `2A-1`): これが最も難しい点です。
      - **案 A（推奨）**: まずはシンプルに、移行ラベルも複合ラベルと同様に扱い、両方のラベルが存在するものとしてエンコードします (`2A`と`1`の要素を`1`にする)。「A から B へ移行中」＝「A と B の両方の特徴が混在している状態」と解釈するアプローチです。これで大半のケースを捉えられるはずです。

### ステップ 2：データ不均衡への対策

台風ラベル（6A, 6B, 6C）などが極端に少ない問題を解決しないと、モデルは多数派ラベルを予測するだけで高いスコアを出してしまい、重要な現象を見逃します。

- **クラスの重み付け（Class Weighting）**:
  - **考え方**: 学習時の損失計算において、希少なラベル（台風など）を間違えた場合のペナルティ（損失）を、多数派ラベルを間違えた場合よりも何倍も重く設定します。
  - **実装**: TensorFlow/Keras などのフレームワークでは、モデルの`fit`メソッドに `class_weight`という引数を渡すだけで簡単に実装できます。各ラベルの出現数の逆数などを基に重みを計算します。
- **データ拡張（Data Augmentation）**:
  - **考え方**: 希少クラスの気圧配置図データに対して、気象学的に意味を損なわない範囲で微小な変換を加え、水増しします。
  - **例**: 画像をわずかに平行移動させたり、回転させたり、微小なノイズを加えたりします。これにより、モデルはより多様なパターンに頑健になります。

### ステップ 3：学習プロセス

1.  **データ正規化**: 全ての入力変数（SLP、ジオポテンシャル高度など）は、物理的なスケールが大きく異なります。学習を安定させるため、各変数を個別に**標準化**（平均を 0、標準偏差を 1 に変換）することが不可欠です。学習データの平均と標準偏差を計算し、それを使って検証・テストデータも変換します。
2.  **データ分割**: データを学習用（1991–1997 年）、検証用（1998–2000 年）に分割します。検証用データは、学習中にモデルの性能を監視し、過学習を防ぐために使います。
3.  **モデル学習**: 上記で設計した CNN モデルと前処理済みデータを使って学習を開始します。検証用データの損失が下がらなくなったら学習を停止する（Early Stopping）などのテクニックも有効です。

---

## 4. モデルの評価方法

通常の分類問題で使われる「正解率（Accuracy）」は、データ不均衡があるため指標として不適切です。以下のマルチラベル分類用の指標を用いるべきです。

- **ラベル毎の評価**:
  - **適合率（Precision）、再現率（Recall）、F1 スコア**: これらを各基本ラベル（`1`, `2A`, ...）ごとに計算します。これにより、「台風(6B)をどれだけ見逃さずに検出できたか（再現率）」や「台風(6B)と予測したもののうち、本当に正解だった割合（適合率）」を個別に評価でき、モデルの弱点が明確になります。
- **全体評価**:
  - **ハミング損失（Hamming Loss）**: 全ラベルの中で、予測が間違っていたラベルの割合の平均。0 に近いほど良いモデルです。
  - **Jaccard 係数（Jaccard Score）**: 「予測したラベルの集合」と「正解ラベルの集合」の一致度を測る指標。1 に近いほど良いモデルです。

これらの手法と評価指標を用いることで、複合ラベルや希少ラベルを含む複雑な気圧配置分類タスクに対して、客観的かつ高性能なモデルを構築できる可能性が非常に高いです。ご研究の成功を心より応援しております。
