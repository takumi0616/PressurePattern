# 類似度指標とクラスタリング手法の比較を通じた気圧配置パターン分類の高度化

## 先行研究

### 1) 木村ほか (2009)「サポートベクターマシンを用いた気圧配置の自動分類（DEIM Forum 2009）」

- 目的
  - 目視で行っていた「西高東低」「谷」「移動性高気圧」「前線」「南高北低」「台風」の抽出を、SVM で自動化。
- データ・設定
  - 入力：JRA‑25 の海面更正気圧（SLP）、日本周辺（約 1.25°）2109 格子、毎日 09JST。
  - ラベル：吉野（2002）の 6 基本型（移行・複合あり）。
  - 手法：各型ごとに「その型を持つ/持たない」の二値 SVM（RBF カーネル）、一対他。TinySVM を利用。
- 主な結果
  - F 値（参考）：西高東低 ≈0.86、移動性高気圧 ≈0.76、谷/前線 ≈0.69、南高北低 ≈0.58、台風 ≈0.41。
  - しきい値の操作で適合率–再現率のトレードオフを制御。プロトタイプ検索システムで有用性を検証。
- 含意・限界
  - 大量抽出の自動化に有効。一方、台風など多様性の大きい型やラベルの主観性が課題。
- 本研究への示唆
  - 教師あり学習の有効性を示す一方で、ラベル付けコストや多様なパターン対象（台風など）の難しさが明確。教師なし学習の比較検討が動機となる。

---

### 2) Takasuka et al. (2024)「自己組織化マップを用いた気圧配置のクラスタリングと 1km メッシュ天気データによる分析」

- 目的
  - 教師なし学習（Batch‑SOM）で気圧配置の代表パターンを抽出し、全国 1km 推計天気（晴/曇/雨雪）と対応付けて解釈。
- データ・設定
  - 入力：GPV 全球の SLP（2016/3–2024/10、09JST）、領域 15–55N/115–155E。
  - 前処理：領域平均差分 →PCA20 次元 →Batch‑SOM（10×10、学習 10 万）。
  - 事後解釈：冬/夏/梅雨/台風のキーワード日でノードにラベル付与。
- 主な結果
  - SOM 上で隣接ノードが類似配置を形成（構造の連続性）。各クラスタに対応する日本の天気分布を可視化。
  - 汎化評価（JRA‑3Q の 100 事例）：冬 100%、夏 84%、梅雨 76%、台風 52%（平均 78%）。
- 含意・限界
  - 教師なしでも連続的な型空間を作れ、地上天気との結び付けが可能。台風は多様性ゆえ精度が低め。
- 本研究への示唆
  - SOM の有効性と可視化力を確認。一方で類似度にユークリッド距離（EUC）を用いており、パターン構造の捉え方に改善余地。

---

### 3) Philippopoulos et al. (2014, International Journal of Energy and Environment)「SOM と k-means の性能比較：南東欧の春季 MSLP 分類」

- 目的
  - SOM と k-means を総観場分類で正面比較し、得られるパターン・頻度・季節性の実用性を評価。
- データ・設定
  - 入力：NCEP/NCAR Reanalysis 1 の日平均 MSLP（1948–2009 春期）、2.5°、30–60N/10W–37.5E、5704 日。
  - 前処理：PCA 25 成分（分散 99.01%）。
  - 手法：k-means（EUC, k=6–13）、SOM（12–36 ノード → 最適 5×4=20、BMU=EUC）。
- 主な結果
  - 両手法とも現実的な型を与えるが、SOM は非線形構造を写像し、近縁型が隣接配置（トポロジ保存）。
  - 高気圧卓越型で一致度が高く、弱圧場/組合せ型で差異。
- 本研究への示唆
  - SOM の可視化・遷移解釈の強み、および距離指標・型数固定の限界が示される。距離指標の改良（SSIM/S1）導入の動機付け。

---

### 4) Jiang, Dirks & Luo (2013, Weather and Climate 33:52–75)「SOM によるニュージーランドの総観型分類と気象・大気質データの可視化」

- 目的
  - Z1000 から SOM で 25 総観型を作成し、Auckland の局地気象・大気質（NO/NO2/O3）を SOM 平面上で可視化・解釈。
- 主な結果
  - SOM 上の自己配置で、西風トラフ群・ブロッキング・南西流などが空間的に整理。
  - PC 指標（風向/安定度）の投影や大気質の型依存性を直観的に解釈可能。
- 本研究への示唆
  - SOM は分類と同時に「関係の地図化」を可能にする一方、距離が EUC・型数固定という制約が残る。距離の改善が必要。

---

### 5) Winderlich et al. (2024, ESD)「改良 SSIM による二段階クラスタリングでの総観場分類」

- 目的
  - SSIM（混合符号に耐性を持つ改良版）を用い、クラス数を自動決定、クラス代表を medoid とするクラスタリングを提案。
- 主な結果
  - 37–89 クラス（閾値で制御）が、分離・安定性・代表性を満たす。まれな型も保持。
- 本研究への示唆
  - 「平均（centroid）」ではなく「実サンプル（medoid）」を代表として地図表示する発想は、SOM 結果の可視化にも有用。本研究では結果表示に SOM ノードの medoid（コードブックに最も近い実サンプル）を併記 する仕様を採用し、同研究から着想を得たと位置付ける。

---

### 6) Doan et al. (2021, GMD)「S‑SOM v1.0：構造類似（SSIM）を用いた SOM」

- 目的
  - SOM の BMU 探索に SSIM を導入し、構造（高低の位置・形・コントラスト）に敏感なクラスタリングを実現。
- 主な結果
  - ED‑SOM よりクラスタ純度（シルエット）が高く、トポロジ保存（Topographic Error）も概ね改善。
- 本研究への示唆
  - SOM の BMU 類似度を SSIM に置換するだけで性能向上が見込める。本研究の比較条件（Batch‑SOM: SSIM）の直接的背景。

---

### 7) Sato & Kusaka (2021, JMSJ)「SLP パターン分類における類似度指標の統計比較」

- 目的
  - 類似度（COR/EUC/S1/SSIM/aHash）の違いが SLP パターン選別に与える影響を統計比較。
- 主な結果
  - 平均・最大の選択率で S1 と SSIM が最良。ノイズを含む教師に対しても頑健。EUC は構造差に弱い。
- 本研究への示唆
  - 本研究で S1/SSIM を SOM 類似度に用いる根拠。

### まとめ（本研究への接続）

- 構造を持つ場（SLP）の類似は、L2/MSE より SSIM（構造）/S1（勾配） が人の判断との整合性・頑健性で優位。
- SOM の可視化力を活かしつつ、BMU 類似度を EUC/SSIM/S1 で比較 することにより、分類精度と解釈性の両面で最適解を探索する。
- さらに、Winderlich で示された medoid 表示 の思想を可視化へ導入し、SOM の平均化による“ぼけ”を補う。

---

## 実験計画

### 1. はじめに

気圧配置の客観分類は、検索・型別検証・モデル評価等の実務応用に不可欠である。教師あり分類の先駆（木村ほか, 2009）の成果と限界、SOM の可視化力（Jiang 2013）と距離・型数の課題、SSIM/S1 類似度の優位（Doan 2021; Sato & Kusaka 2021）が示唆を与える。本研究は Batch‑SOM に対して EUC／SSIM／S1 の 3 類似度 を統一条件で比較し、分類性能・希少型の抽出・可視化解釈性を総合評価する。

### 2. 本研究の目的

海面更正気圧（SLP）の日本域気圧配置分類において、Batch‑SOM の BMU 類似度（EUC／SSIM／S1） の違いが性能・可視化に及ぼす影響を、同一データ・同一評価系で比較して明らかにする。加えて、SOM ノードの medoid 表示 を導入し、解釈性の向上を図る。

### 3. 使用データ

#### 3.1. 物理量と期間

- 物理量：海面更正気圧（SLP）
- 期間：1991-01-01 〜 2000-12-31（1 日 1 時刻、09JST 相当）

#### 3.2. 領域と解像度

- 日本周辺（概ね 115–155E, 15–55N、実データ格子に準拠）

#### 3.3. ラベル（正解データ）

- 吉野（2002）に基づく 15 基本ラベル  
  `1, 2A, 2B, 2C, 2D, 3A, 3B, 3C, 3D, 4A, 4B, 5, 6A, 6B, 6C`
- 複合ラベル（例：`3A−2D`, `2A+2C` など）も含まれ、全日ラベルあり。

#### 3.4. 前処理

- SLP を hPa へ統一し、日々の領域平均を差し引いた偏差場を入力とする（季節変動の正規化は本比較では未実施）。
- すべての手法で同一入力を使用。

### 4. 研究方法（比較条件）

本研究は Batch‑SOM × 3 類似度（EUC／SSIM／S1） の比較である。結果表示は「セントロイド図」に加え、各ノードの「medoid（コードブックに最も近い実データ）」図を併記する（Winderlich et al., 2024 に着想）。

#### 4.1. ① Batch‑SOM（EUC）

- SOM：10×10、バッチ学習、反復 10,000、ガウス近傍（σ 漸減）、学習率漸減
- BMU 類似度：ユークリッド距離
- 可視化：ノード平均（セントロイド）図、および medoid 図（EUC 最近傍の実サンプル）

#### 4.2. ② Batch‑SOM（SSIM）

- SOM 設定は ① と同一、BMU 類似度のみ SSIM に置換（Doan et al., 2021 に準拠、単窓 SSIM）
- 可視化：セントロイド図＋ medoid 図（SSIM 最大の実サンプル）

#### 4.3. ③ Batch‑SOM（S1）

- SOM 設定は ① と同一、BMU 類似度のみ S1（Teweles–Wobus スコア）に置換（Sato & Kusaka, 2021）
- 可視化：セントロイド図＋ medoid 図（S1 最小の実サンプル）

### 5. 評価指標（3 条件で共通）

- Macro Recall（基本ラベル）：各基本ラベル `l` について、クラスタ多数決ラベルが `l` のクラスタ群に入った `l` の件数 / `l` 総件数を算出し、15 ラベルで平均。
- Macro Recall（複合考慮）：複合ラベルを基本成分に展開し、予測（クラスタ多数決）がその成分のいずれかに一致すればその成分に対し正とカウント、ラベルごとに再現率 → マクロ平均。
- 付随指標（報告・可視目的）：クラスタ内ラベル分布エントロピー、ノード別件数、季節別頻度。
- 可視化：各条件の セントロイド図 と medoid 図 を並列提示。

### 6. 実装・ハイパーパラメータ

- SOM：10×10、学習反復 10,000、バッチ 512、学習率/σ は指数減衰、PyTorch 実装（GPU 使用可）
- 類似度：EUC / SSIM / S1（BMU 探索に使用）。SSIM は単一窓・面積重みなしの簡易版を用いる。
- 入力：SLP 偏差 [hPa]

---

## 実験結果（更新）

### 1. 総括（マクロ平均再現率）

3 条件のマクロ平均再現率（基本ラベル／複合考慮）を以下に示す。S1‑SOM（③）が最良、EUC‑SOM（①）がベースライン、SSIM‑SOM（②）は本設定ではやや劣後した。

| 実験条件                       | MacroRecall (基本ラベル) | MacroRecall (複合考慮) |
| :----------------------------- | :----------------------- | :--------------------- |
| ① Batch SOM (ユークリッド距離) | 0.278                    | 0.194                  |
| ② Batch SOM (SSIM)             | 0.235                    | 0.179                  |
| ③ Batch SOM (S1 スコア)        | 0.350                    | 0.241                  |

- ① SOM マップ（セントロイド）  
  ![画像](./image/1_maps_10x10.png)
- ① SOM マップ（medoid）  
  ![画像](./image/1_medoid_maps_10x10.png)

- ② SOM マップ（セントロイド）  
  ![画像](./image/2_maps_10x10.png)
- ② SOM マップ（medoid）  
  ![画像](./image/2_medoid_maps_10x10.png)

- ③ SOM マップ（セントロイド）  
  ![画像](./image/3_maps_10x10.png)
- ③ SOM マップ（medoid）  
  ![画像](./image/3_medoid_maps_10x10.png)

> 注：medoid は各ノードのコードブック（重みベクトル）に 最も近い実サンプル（距離は各手法の BMU 類似度に一致）として定義。平均化による“ぼけ”を避け、等圧線の位置・形状・コントラストを保ったまま代表例を提示できる（Winderlich et al., 2024 の思想に基づく可視化拡張）。

---

### 2. ラベル別再現率（基本／基本＋応用）

代表的なラベル別再現率を列挙する（太字は台風 3 型）。

#### 2.1 ① Batch‑SOM（EUC）

| ラベル | 再現率（基本） | 再現率（基本＋応用） |
| ------ | -------------: | -------------------: |
| 1      |         0.8880 |               0.7461 |
| 2A     |         0.4590 |               0.1734 |
| 2B     |         0.0370 |               0.0181 |
| 2C     |         0.1125 |               0.0551 |
| 2D     |         0.4706 |               0.4008 |
| 3A     |         0.2453 |               0.1021 |
| 3B     |         0.7259 |               0.5759 |
| 3C     |         0.0000 |               0.0000 |
| 3D     |         0.1429 |               0.0914 |
| 4A     |         0.6207 |               0.5342 |
| 4B     |         0.1905 |               0.0794 |
| 5      |         0.2319 |               0.1384 |
| 6A     |         0.0000 |               0.0000 |
| 6B     |         0.0000 |               0.0000 |
| 6C     |         0.0000 |               0.0000 |

#### 2.2 ② Batch‑SOM（SSIM）

| ラベル | 再現率（基本） | 再現率（基本＋応用） |
| ------ | -------------: | -------------------: |
| 1      |         0.9280 |               0.8789 |
| 2A     |         0.0984 |               0.0359 |
| 2B     |         0.0247 |               0.0253 |
| 2C     |         0.0500 |               0.0290 |
| 2D     |         0.2588 |               0.2176 |
| 3A     |         0.2453 |               0.1381 |
| 3B     |         0.6854 |               0.5712 |
| 3C     |         0.0693 |               0.0553 |
| 3D     |         0.0317 |               0.0108 |
| 4A     |         0.6256 |               0.4925 |
| 4B     |         0.1349 |               0.0664 |
| 5      |         0.2899 |               0.1415 |
| 6A     |      0.2857(2) |           0.0606(10) |
| 6B     |         0.0000 |               0.0000 |
| 6C     |         0.0000 |               0.0000 |

#### 2.3 ③ Batch‑SOM（S1）

| ラベル | 再現率（基本） | 再現率（基本＋応用） |
| ------ | -------------: | -------------------: |
| 1      |         0.9013 |               0.8184 |
| 2A     |         0.3934 |               0.1599 |
| 2B     |         0.1111 |               0.0505 |
| 2C     |         0.1500 |               0.0696 |
| 2D     |         0.6118 |               0.4924 |
| 3A     |         0.3019 |               0.1201 |
| 3B     |         0.7944 |               0.6223 |
| 3C     |         0.0000 |               0.0000 |
| 3D     |         0.0000 |               0.0000 |
| 4A     |         0.6502 |               0.5526 |
| 4B     |         0.2540 |               0.1097 |
| 5      |         0.4203 |               0.2296 |
| 6A     |      0.5714(4) |           0.3152(52) |
| 6B     |      0.0667(1) |            0.0147(1) |
| 6C     |         0.0000 |               0.0000 |

---

### 3. 台風型（6A/6B/6C）の抽出状況

- EUC‑SOM（①）：6A/6B/6C はいずれも 0%。平均化により多様で希少な形が埋没。
- SSIM‑SOM（②）：6A は 0.2857（n=2）まで改善するものの、6B/6C は 0%。SSIM 実装・前処理の工夫余地。
- S1‑SOM（③）：6A=0.5714, 6B=0.0667 を捉えた（6C=0）。勾配ベースの類似度が台風周辺の急峻構造に有利であることを裏付ける。
- medoid 表示：希少型が混在するノードでも、medoid 図では実サンプルが提示されるため、低頻度パターンの視認・検証に有効。

---

### 4. セントロイド表示 vs medoid 表示（SOM 可視化の比較）

- セントロイド（平均）：混合が強いほどパターンが太り、前線のシャープさや低圧核の位置がぼける。
- medoid（実サンプル）：等圧線の形状・位置・コントラストが保持され、解釈しやすい。とくに希少/多様な型の代表提示に有効。  
  本研究では 全条件でセントロイド図と medoid 図を併記 し、現場解釈性を高めた（Winderlich et al., 2024 の思想に基づく）。

---

## 考察

1. S1‑SOM（③）が最良の分類精度  
   勾配に敏感な S1 は、冬型（1）、移動性高気圧（3B）、2D/4A など水平勾配が鍵となる型で優位。台風（6A/6B）も一部捉え、Macro Recall（基本）0.35 を達成。

2. medoid 表示の導入で可視化・解釈性が向上  
   SOM の弱点である平均化による“ぼけ”を補完し、実サンプルに基づく代表図で低頻度パターンの目視確認が容易に。検索カタログや事例集に適する。

3. SSIM‑SOM（②）は本設定では劣後  
   先行研究では優位性が示されているが、今回は単一窓・面積重みなし・季節標準化なしという簡易実装のため、SSIM の力を十分引き出せていない可能性。改良 SSIM の導入で改善余地がある。

4. EUC‑SOM（①）はベースライン  
   頻出型の粗い分類には有効だが、構造差や希少型の抽出に弱い。S1/SSIM への置換が望ましい。

---

## 結論と今後の展望

- 結論

  - S1‑SOM が精度最良。主要季節型に強く、台風型の一部も拾える。
  - medoid 表示 は解釈性と実務有用性（事例提示・検証）を大幅に高める。SOM 可視化の標準機能として推奨。
  - SSIM‑SOM は実装改良の余地を残すが、構造敏感な類似度として期待が持てる。

- 実務への推奨

  1. 分類の既定値：S1‑SOM（10×10 など適切サイズ）を推奨。
  2. 可視化：各ノードで セントロイド図＋ medoid 図 を併記し、現場の解釈・点検を容易にする。
  3. 希少型モニタ：台風・特殊谷などは medoid 図を中心に監視・検索リスト化。

- 今後の改善
  - 改良 SSIM（混合符号対応、c1=c2=1e-8、等面積重み、季節別 σ 正規化など）で SSIM‑SOM を再評価。
  - SOM サイズ・季節別学習 や 複数変数（風/渦度/温位）を含む多変量類似度 の導入。
  - クラスタ代表性の定量化（クラスタ内ラベルエントロピー、medoid–centroid 類似など）を標準評価に追加。
  - 自動クラスタの拡張：類似度しきい値ベースの medoid 中心クラスタリング等、SOM と相補的な枠組みを将来検討。

> まとめ：S1‑SOM × medoid 可視化 という現実的な組合せで、精度と解釈性のバランスが高い気圧配置分類フレームを提示した。今後は改良 SSIM の実装と多変量化で、構造敏感な分類の性能をさらに引き上げる。

---

## 参考文献

1. 木村広希, 川島英之, 日下博幸, & 北川博之. (2009). サポートベクターマシンを用いた気圧配置検出手法の提案 ── 西高東低冬型を対象として ──. 地理学評論 Series A, 82(4), 323-331.

2. 高須賀 匠, 高野 雄紀, 渡邊 正太郎, & 雲居 玄道. (2024). 自己組織化マップを用いた気圧配置のクラスタリングと 1km メッシュ天気データによる分析. 情報処理学会全国大会.

3. Philippopoulos, K., Deligiorgi, D., & Kouroupetroglou, G. (2014). Performance comparison of self-organizing maps and k-means clustering techniques for atmospheric circulation classification. methods, 13, 14.

4. Jiang, N., Dirks, K. N., & Luo, K. (2013). Classification of synoptic weather types using the self-organising map and its application to climate and air quality data visualisation. Weather and Climate, 33, 52-75.

5. Winderlich, K., Dalelane, C., & Walter, A. (2024). Classification of synoptic circulation patterns with a two-stage clustering algorithm using the modified structural similarity index metric (SSIM). Earth System Dynamics, 15(3), 607-633.

6. Doan, Q. V., Kusaka, H., Sato, T., & Chen, F. (2021). S-SOM v1. 0: a structural self-organizing map algorithm for weather typing. Geoscientific Model Development, 14(4), 2097-2111.

7. Sato, T., and H. Kusaka, 2021: Statistical intercomparison of similarity metrics in sea level pressure pattern classification. J. Meteor. Soc. Japan, 99, 993–1001, doi:10.2151/jmsj.2021-047
